<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki Pro (Stats Mode)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        nav { background: white; padding: 15px 5px; display: flex; justify-content: space-around; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .nav-item { font-weight: bold; color: #aaa; cursor: pointer; padding: 5px 10px; font-size: 14px; flex: 1; text-align: center; }
        .nav-item.active { color: black; border-bottom: 2px solid black; }
        .container { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .screen { width: 100%; max-width: 450px; display: none; } 
        .screen.active { display: block; } 
        
        /* ê³µí†µ ìŠ¤íƒ€ì¼ */
        .card-box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .add-btn { background: black; color: white; width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        /* ë¦¬ìŠ¤íŠ¸ ë° ë²„íŠ¼ */
        .card-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .mini-btn { border: none; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; color: white; }
        .edit-btn { background: #4a90e2; }
        .del-btn { background: #ff4d4d; }

        /* í†µê³„ íƒ­ ì „ìš© */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-value { display: block; font-size: 22px; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 12px; color: #888; }
        canvas { background: white; border-radius: 12px; padding: 10px; box-sizing: border-box; }

        /* í•™ìŠµ ì¹´ë“œ */
        .card { background: white; border-radius: 20px; padding: 40px 20px; min-height: 300px; width: 100%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; margin-bottom: 20px; }
        .front { font-size: 28px; font-weight: bold; color: #333; }
        .back { font-size: 22px; color: #007bff; margin-top: 30px; font-weight: bold; }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:999; display: flex; justify-content: center; align-items: center; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>

    <nav>
        <div id="tab-manage" class="nav-item active" onclick="ui.switchTab('manage')">ì¹´ë“œê´€ë¦¬</div>
        <div id="tab-study" class="nav-item" onclick="ui.switchTab('study')">ë‹¨ì–´ê³µë¶€</div>
        <div id="tab-stats" class="nav-item" onclick="ui.switchTab('stats')">í†µê³„</div>
    </nav>

    <div class="container">
        <div id="view-manage" class="screen active">
            <div class="card-box" style="text-align: center;">
                <span id="due-count" style="font-weight:bold; color:#007bff; font-size:18px;">0</span>ê°œ ë³µìŠµ í•„ìš”
                <span style="margin: 0 10px; color:#ddd;">|</span>
                <span id="total-count" style="font-weight:bold; font-size:18px;">0</span>ê°œ ì €ì¥ë¨
            </div>
            <div class="card-box">
                <h3 style="margin-top:0;">ìƒˆ ì¹´ë“œ ì¶”ê°€</h3>
                <input type="text" id="new-front" placeholder="ì•ë©´ (íŠ¸ë¦¬ê±°/ìƒí™©)">
                <input type="text" id="new-back" placeholder="ë’·ë©´ (ì˜ì–´ ë¬¸ì¥)">
                <button class="add-btn" onclick="logic.addCard()">ì €ì¥í•˜ê¸°</button>
            </div>
            <div id="card-list-area"></div>
            <div style="display:flex; justify-content:center; gap:20px; margin-top:10px; padding-bottom:30px;">
                <button onclick="logic.changePage(-1)" id="prev-btn">ì´ì „</button>
                <span id="page-info">1 / 1</span>
                <button onclick="logic.changePage(1)" id="next-btn">ë‹¤ìŒ</button>
            </div>
        </div>

        <div id="view-study" class="screen">
            <div id="study-content" style="display:none; width:100%;">
                <div id="card-display" class="card" onclick="ui.flipCard()">
                    <div id="card-text">ë¡œë”© ì¤‘...</div>
                </div>
                <div id="rating-btns" style="display: none; gap: 10px;">
                    <button style="flex:1; padding:15px; background:#ffadad; border:none; border-radius:10px;" onclick="logic.rateCard(1)">Again</button>
                    <button style="flex:1; padding:15px; background:#caffbf; border:none; border-radius:10px;" onclick="logic.rateCard(5)">Easy</button>
                </div>
            </div>
            <div id="no-study" style="text-align: center; display: block;">
                <h2>ğŸ‰</h2><h3>ì˜¤ëŠ˜ ë¶„ëŸ‰ ì™„ë£Œ!</h3>
                <button class="add-btn" onclick="ui.switchTab('manage')">ëŒì•„ê°€ê¸°</button>
            </div>
        </div>

        <div id="view-stats" class="screen">
            <div class="stat-grid">
                <div class="stat-card">
                    <span id="stat-total" class="stat-value">0</span>
                    <span class="stat-label">ì „ì²´ ì¹´ë“œ</span>
                </div>
                <div class="stat-card">
                    <span id="stat-learned" class="stat-value">0</span>
                    <span class="stat-label">í•™ìŠµ ì§„í–‰ë¨</span>
                </div>
            </div>
            <div class="card-box">
                <h4 style="margin-top:0;">í•™ìŠµ ë¶„í¬ (Interval ê¸°ì¤€)</h4>
                <canvas id="intervalChart" width="100%" height="200"></canvas>
            </div>
            <div class="card-box">
                <h4 style="margin-top:0;">ë³µìŠµ ìŠ¤ì¼€ì¤„ (í–¥í›„ 7ì¼)</h4>
                <canvas id="forecastChart" width="100%" height="200"></canvas>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBaf_WMp-HO061x8di3e2Z_bFrSytngQGA",
            authDomain: "anki-27849.firebaseapp.com",
            projectId: "anki-27849",
            storageBucket: "anki-27849.firebasestorage.app",
            messagingSenderId: "3948908398",
            appId: "1:3948908398:web:65ee16620c4caee6d03b7f",
            measurementId: "G-19J7ZJVV0S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const DOC_ID = "my_cards_data";

        let cards = [];
        let currentCard = null;
        let currentPage = 1;
        const PAGE_SIZE = 20;
        let editingCardId = null;
        let chart1, chart2;

        window.ui = {
            switchTab: (tabName) => {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tabName}`).classList.add('active');
                document.getElementById(`view-${tabName}`).classList.add('active');
                if (tabName === 'study') logic.prepareStudy();
                if (tabName === 'stats') ui.renderStats();
            },
            flipCard: () => {
                if (!currentCard) return;
                document.getElementById('card-text').innerHTML = `<div class="front">${currentCard.front}</div><div class="back">${currentCard.back}</div>`;
                document.getElementById('rating-btns').style.display = 'flex';
            },
            renderList: () => {
                const listArea = document.getElementById('card-list-area');
                listArea.innerHTML = '';
                const reversed = [...cards].reverse();
                const totalPages = Math.ceil(cards.length / PAGE_SIZE) || 1;
                const paged = reversed.slice((currentPage-1)*PAGE_SIZE, currentPage*PAGE_SIZE);

                paged.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'card-item';
                    if(editingCardId === card.id) {
                        div.innerHTML = `<input id="ef-${card.id}" value="${card.front}"><input id="eb-${card.id}" value="${card.back}">
                                         <button onclick="logic.updateCard(${card.id})">ì €ì¥</button>`;
                    } else {
                        div.innerHTML = `<div style="display:flex; justify-content:space-between;">
                            <div><b>${card.front}</b><br><small>${card.back}</small></div>
                            <div><button class="mini-btn edit-btn" onclick="logic.startEdit(${card.id})">ìˆ˜ì •</button>
                            <button class="mini-btn del-btn" onclick="logic.deleteCard(${card.id})">ì‚­ì œ</button></div>
                        </div>`;
                    }
                    listArea.appendChild(div);
                });
                document.getElementById('page-info').innerText = `${currentPage} / ${totalPages}`;
            },
            renderStats: () => {
                document.getElementById('stat-total').innerText = cards.length;
                document.getElementById('stat-learned').innerText = cards.filter(c => c.repetitions > 0).length;

                // 1. Interval ë¶„í¬ ì°¨íŠ¸ (ì–¼ë§ˆë‚˜ ì¥ê¸°ê¸°ì–µìœ¼ë¡œ ê°”ë‚˜?)
                const intervals = [0, 0, 0, 0]; // 0-1ì¼, 2-7ì¼, 8-30ì¼, 30ì¼+
                cards.forEach(c => {
                    if (c.interval <= 1) intervals[0]++;
                    else if (c.interval <= 7) intervals[1]++;
                    else if (c.interval <= 30) intervals[2]++;
                    else intervals[3]++;
                });

                if(chart1) chart1.destroy();
                chart1 = new Chart(document.getElementById('intervalChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['ë‹¨ê¸°', 'ì¤‘ê¸°', 'ì¥ê¸°', 'ì™„ì „í•™ìŠµ'],
                        datasets: [{ data: intervals, backgroundColor: ['#ffadad', '#ffd6a5', '#fdffb6', '#caffbf'] }]
                    }
                });

                // 2. í–¥í›„ ë³µìŠµ ìŠ¤ì¼€ì¤„ (ì¼ì£¼ì¼ì¹˜)
                const forecast = new Array(7).fill(0);
                const today = new Date();
                cards.forEach(c => {
                    const diff = Math.ceil((new Date(c.nextReview) - today) / (1000*60*60*24));
                    if (diff >= 0 && diff < 7) forecast[diff]++;
                });

                if(chart2) chart2.destroy();
                chart2 = new Chart(document.getElementById('forecastChart'), {
                    type: 'bar',
                    data: {
                        labels: ['ì˜¤ëŠ˜', 'ë‚´ì¼', 'D+2', 'D+3', 'D+4', 'D+5', 'D+6'],
                        datasets: [{ label: 'ë³µìŠµ ì¹´ë“œìˆ˜', data: forecast, backgroundColor: '#007bff' }]
                    }
                });
            }
        };

        window.logic = {
            loadCards: async () => {
                document.getElementById('loading').style.display = 'flex';
                const docSnap = await getDoc(doc(db, "anki", DOC_ID));
                cards = docSnap.exists() ? (docSnap.data().list || []) : [];
                ui.renderList();
                document.getElementById('due-count').innerText = cards.filter(c => c.nextReview <= new Date().toISOString().split('T')[0]).length;
                document.getElementById('total-count').innerText = cards.length;
                document.getElementById('loading').style.display = 'none';
            },
            saveToDB: async () => {
                await setDoc(doc(db, "anki", DOC_ID), { list: cards });
                logic.loadCards();
            },
            addCard: async () => {
                const f = document.getElementById('new-front').value;
                const b = document.getElementById('new-back').value;
                if(!f || !b) return;
                cards.push({ id: Date.now(), front: f, back: b, interval: 0, repetitions: 0, easeFactor: 2.5, nextReview: new Date().toISOString().split('T')[0] });
                await logic.saveToDB();
                document.getElementById('new-front').value = ''; document.getElementById('new-back').value = '';
            },
            startEdit: (id) => { editingCardId = id; ui.renderList(); },
            updateCard: async (id) => {
                const card = cards.find(c => c.id === id);
                card.front = document.getElementById(`ef-${id}`).value;
                card.back = document.getElementById(`eb-${id}`).value;
                editingCardId = null;
                await logic.saveToDB();
            },
            deleteCard: async (id) => {
                if(confirm('ì‚­ì œ?')) { cards = cards.filter(c => c.id !== id); await logic.saveToDB(); }
            },
            changePage: (n) => { currentPage += n; ui.renderList(); },
            prepareStudy: () => {
                const today = new Date().toISOString().split('T')[0];
                const due = cards.filter(c => c.nextReview <= today);
                if(due.length > 0) {
                    currentCard = due[0];
                    document.getElementById('study-content').style.display = 'block';
                    document.getElementById('no-study').style.display = 'none';
                    document.getElementById('card-text').innerHTML = `<div class="front">${currentCard.front}</div>`;
                    document.getElementById('rating-btns').style.display = 'none';
                } else {
                    document.getElementById('study-content').style.display = 'none';
                    document.getElementById('no-study').style.display = 'block';
                }
            },
            rateCard: async (q) => {
                let { interval, repetitions, easeFactor } = currentCard;
                if (q >= 3) {
                    if (repetitions === 0) interval = 1;
                    else if (repetitions === 1) interval = 6;
                    else interval = Math.round(interval * easeFactor);
                    repetitions++;
                } else { repetitions = 0; interval = 1; }
                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + interval);
                currentCard.interval = interval; currentCard.repetitions = repetitions;
                currentCard.nextReview = nextDate.toISOString().split('T')[0];
                await logic.saveToDB();
                logic.prepareStudy();
            }
        };

        logic.loadCards();
    </script>
</body>
</html>
