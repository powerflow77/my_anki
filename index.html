<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ ë‹¨ì–´ì¥ (Final)</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ë°” (íƒ­ 2ê°œë¡œ ë³µêµ¬) */
        nav { background: white; padding: 15px 5px; display: flex; justify-content: space-around; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .nav-item { font-weight: bold; color: #aaa; cursor: pointer; padding: 10px 20px; font-size: 16px; }
        .nav-item.active { color: black; border-bottom: 2px solid black; }
        
        .container { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .screen { width: 100%; max-width: 450px; display: none; } 
        .screen.active { display: block; } 

        /* í†µê³„(í˜„í™©) ë°•ìŠ¤ */
        .status-box { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-row { display: flex; justify-content: space-around; align-items: center; text-align: center; }
        .stat-label { font-size: 11px; color: #888; margin-bottom: 5px; font-weight: bold; letter-spacing: 1px; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .v-line { width: 1px; height: 30px; background: #eee; }

        /* ì…ë ¥ ë° ë¦¬ìŠ¤íŠ¸ */
        .input-area { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px;}
        input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .add-btn { background: black; color: white; width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        .list-title { margin: 20px 0 10px 0; font-weight: bold; color: #555; display: flex; justify-content: space-between; align-items: center; }
        .card-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-info { text-align: left; width: 70%; }
        .card-front { font-weight: bold; font-size: 16px; color: #333; margin-bottom: 5px; }
        .card-back { font-size: 14px; color: #888; }
        .del-btn { background: #ff4d4d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; }

        /* ê³µë¶€ ì¹´ë“œ */
        .card { background: white; border-radius: 20px; padding: 40px 20px; min-height: 300px; width: 100%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; margin-bottom: 20px; position: relative; }
        .front { font-size: 30px; font-weight: bold; color: #333; }
        .back { font-size: 24px; color: #007bff; margin-top: 30px; font-weight: bold; }
        
        /* ë²„íŠ¼ ê·¸ë£¹ (ì‹œê°„ í‘œì‹œìš©) */
        .btn-group { display: flex; gap: 8px; width: 100%; }
        .btn-group button { flex: 1; padding: 12px 5px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 13px; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .btn-group button:active { transform: scale(0.95); }

        /* ë¡œë”© í™”ë©´ */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:999; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px; color: #333; }
    </style>
</head>
<body>

    <div id="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>

    <nav>
        <div id="tab-manage" class="nav-item active" onclick="ui.switchTab('manage')">ì¹´ë“œê´€ë¦¬</div>
        <div id="tab-study" class="nav-item" onclick="ui.switchTab('study')">í•™ìŠµí•˜ê¸°</div>
    </nav>

    <div class="container">
        <div id="view-manage" class="screen active">
            
            <div class="status-box">
                <div class="stat-row">
                    <div>
                        <div class="stat-label">NEW</div>
                        <div id="new-count" class="stat-value" style="color:#007bff;">0</div>
                    </div>
                    <div class="v-line"></div>
                    <div>
                        <div class="stat-label">REVIEW</div>
                        <div id="review-count" class="stat-value" style="color:#28a745;">0</div>
                    </div>
                    <div class="v-line"></div>
                    <div>
                        <div class="stat-label">TOTAL</div>
                        <div id="total-count" class="stat-value" style="color:#333;">0</div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <h3 style="margin-top:0; font-size:18px;">ìƒˆ ì¹´ë“œ ì¶”ê°€</h3>
                <input type="text" id="new-front" placeholder="ì•ë©´ (ì§ˆë¬¸/ì˜ì–´)">
                <input type="text" id="new-back" placeholder="ë’·ë©´ (ì •ë‹µ/í•œê¸€)">
                <button class="add-btn" onclick="logic.addCard()">ì €ì¥í•˜ê¸°</button>
            </div>
            
            <div class="list-title"><span>ì„œë²„ ì €ì¥ ëª©ë¡</span> <button onclick="logic.loadCards()" style="background:none; border:none; color:blue; cursor:pointer;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button></div>
            <div id="card-list-area"></div>
        </div>

        <div id="view-study" class="screen">
            <div id="study-content" style="display:none; width:100%;">
                <div class="status-box" style="padding: 10px; margin-bottom: 10px;">
                    <span style="color:#007bff; font-weight:bold;">New: <span id="study-new">0</span></span> 
                    <span style="color:#ddd; margin:0 10px;">|</span>
                    <span style="color:#28a745; font-weight:bold;">Rev: <span id="study-rev">0</span></span>
                </div>

                <div id="card-display" class="card" onclick="ui.flipCard()">
                    <div id="card-text">ë¡œë”© ì¤‘...</div>
                </div>
                <p id="guide-text" style="color:#888; text-align:center;">í„°ì¹˜í•´ì„œ ì •ë‹µ í™•ì¸</p>
                
                <div id="rating-btns" class="btn-group" style="display: none;">
                    <button id="btn-1" style="background:#ffadad" onclick="logic.rateCard(1)">Again</button>
                    <button id="btn-3" style="background:#ffd6a5" onclick="logic.rateCard(3)">Hard</button>
                    <button id="btn-4" style="background:#fdffb6" onclick="logic.rateCard(4)">Good</button>
                    <button id="btn-5" style="background:#caffbf" onclick="logic.rateCard(5)">Easy</button>
                </div>
            </div>
            
            <div id="no-study" style="text-align: center; display: block;">
                <h2>ğŸ‰</h2><h3>ì˜¤ëŠ˜ ê³µë¶€ ë!</h3><p>ë³µìŠµí•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <button class="add-btn" onclick="ui.switchTab('manage')">ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ========================================================
        // [í•„ìˆ˜] ë³¸ì¸ì˜ Firebase í‚¤ê°’ ìœ ì§€ë¨
        // ========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBaf_WMp-HO061x8di3e2Z_bFrSytngQGA",
            authDomain: "anki-27849.firebaseapp.com",
            projectId: "anki-27849",
            storageBucket: "anki-27849.firebasestorage.app",
            messagingSenderId: "3948908398",
            appId: "1:3948908398:web:65ee16620c4caee6d03b7f",
            measurementId: "G-19J7ZJVV0S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const DOC_ID = "my_cards_data";

        let cards = [];
        let currentCard = null;

        window.ui = {
            switchTab: (tabName) => {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tabName}`).classList.add('active');
                document.getElementById(`view-${tabName}`).classList.add('active');
                if (tabName === 'study') logic.prepareStudy();
            },

            // ì¹´ë“œ ë’¤ì§‘ê¸° + ë²„íŠ¼ ì‹œê°„ ê³„ì‚°
            flipCard: () => {
                if (!currentCard) return;
                document.getElementById('card-text').innerHTML = `<div class="front">${currentCard.front}</div><div class="back">${currentCard.back}</div>`;
                document.getElementById('rating-btns').style.display = 'flex';
                document.getElementById('guide-text').style.display = 'none';
                
                logic.updateButtonLabels(); // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            },

            renderList: () => {
                const listArea = document.getElementById('card-list-area');
                listArea.innerHTML = '';
                [...cards].reverse().forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'card-item';
                    div.innerHTML = `<div class="card-info"><div class="card-front">${card.front}</div><div class="card-back">${card.back}</div></div><button class="del-btn" onclick="logic.deleteCard(${card.id})">ì‚­ì œ</button>`;
                    listArea.appendChild(div);
                });
            },

            updateStats: () => {
                const today = new Date().toISOString().split('T')[0];
                const dueCards = cards.filter(c => c.nextReview <= today);
                
                // New(í•œë²ˆë„ ì•ˆë³¸ê±°, Reps=0) vs Review(ë³µìŠµ, Reps>0)
                const newCount = dueCards.filter(c => c.repetitions === 0).length;
                const revCount = dueCards.filter(c => c.repetitions > 0).length;

                // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
                document.getElementById('new-count').innerText = newCount;
                document.getElementById('review-count').innerText = revCount;
                document.getElementById('total-count').innerText = cards.length;

                // ê³µë¶€ í™”ë©´ ìƒë‹¨ ì—…ë°ì´íŠ¸
                if(document.getElementById('study-new')) {
                    document.getElementById('study-new').innerText = newCount;
                    document.getElementById('study-rev').innerText = revCount;
                }
            }
        };

        window.logic = {
            // ì‹œê°„ í¬ë§· (0=10ë¶„, 365=1ë…„)
            formatInterval: (days) => {
                if (days === 0) return "10ë¶„";
                if (days >= 365) return (days / 365).toFixed(1) + "ë…„";
                if (days >= 30) return (days / 30).toFixed(1) + "ë‹¬";
                return days + "ì¼";
            },

            // [í•µì‹¬] ë‹¤ìŒ ë‚ ì§œ ì‹œë®¬ë ˆì´ì…˜ (Easy ë³´ë„ˆìŠ¤ í¬í•¨)
            calculateNext: (quality) => {
                let { interval, repetitions, easeFactor } = currentCard;
                let newInt = interval;
                let newReps = repetitions;
                let newEase = easeFactor;

                if (quality === 1) { // Again
                    newReps = 0;
                    newInt = 0; // ì˜¤ëŠ˜ ë‹¤ì‹œ
                } else {
                    if (newReps === 0) {
                        // [New ì¹´ë“œ] Easy(5)ë©´ 4ì¼, ì•„ë‹ˆë©´ 1ì¼
                        newInt = (quality === 5) ? 4 : 1;
                    } else if (newReps === 1) {
                        newInt = 6;
                    } else {
                        // [ë³µìŠµ ì¹´ë“œ] SM-2 ì•Œê³ ë¦¬ì¦˜
                        let modifier = (quality === 3) ? 1.2 : (quality === 5 ? 1.3 : 1.0);
                        newInt = Math.round(newInt * newEase * modifier);
                    }
                    newReps++;
                }

                // EasyFactor ì¡°ì •
                if (quality !== 1) {
                    newEase += (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                    if (newEase < 1.3) newEase = 1.3;
                }

                return { interval: newInt, repetitions: newReps, easeFactor: newEase };
            },

            // ë²„íŠ¼ ë¼ë²¨ ì—…ë°ì´íŠ¸
            updateButtonLabels: () => {
                const labels = { 1: "Again", 3: "Hard", 4: "Good", 5: "Easy" };
                [1, 3, 4, 5].forEach(q => {
                    const res = logic.calculateNext(q);
                    const timeText = logic.formatInterval(res.interval);
                    document.getElementById(`btn-${q}`).innerText = `${labels[q]} (${timeText})`;
                });
            },

            // í‰ê°€ ì‹¤í–‰
            rateCard: async (quality) => {
                const res = logic.calculateNext(quality);
                
                currentCard.interval = res.interval;
                currentCard.repetitions = res.repetitions;
                currentCard.easeFactor = res.easeFactor;

                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + res.interval);
                currentCard.nextReview = nextDate.toISOString().split('T')[0];

                // Againì´ë©´ ë¦¬ìŠ¤íŠ¸ ë§¨ ë’¤ë¡œ ë³´ë‚´ì„œ ì˜¤ëŠ˜ ë‹¤ì‹œ ë³´ê²Œ í•¨
                if (quality === 1) {
                    alert("ğŸ”„ ì ì‹œ í›„ ë‹¤ì‹œ ë‚˜ì˜µë‹ˆë‹¤!");
                    cards = cards.filter(c => c.id !== currentCard.id);
                    cards.push(currentCard);
                }

                await logic.saveToDB();
                logic.prepareStudy(); // ë‹¤ìŒ ì¹´ë“œë¡œ
            },

            // --- ê¸°ë³¸ ê¸°ëŠ¥ë“¤ ---
            loadCards: async () => {
                document.getElementById('loading').style.display = 'flex';
                try {
                    const docSnap = await getDoc(doc(db, "anki", DOC_ID));
                    cards = docSnap.exists() ? (docSnap.data().list || []) : [];
                    ui.renderList();
                    ui.updateStats();
                } catch (e) { alert("ë¡œë“œ ì—ëŸ¬: " + e.message); }
                document.getElementById('loading').style.display = 'none';
            },

            saveToDB: async () => {
                await setDoc(doc(db, "anki", DOC_ID), { list: cards });
                ui.updateStats();
            },

            addCard: async () => {
                const f = document.getElementById('new-front').value;
                const b = document.getElementById('new-back').value;
                if (!f || !b) return alert('ì…ë ¥í•˜ì„¸ìš”!');
                cards.push({ id: Date.now(), front: f, back: b, interval: 0, repetitions: 0, easeFactor: 2.5, nextReview: new Date().toISOString().split('T')[0] });
                await logic.saveToDB();
                document.getElementById('new-front').value = '';
                document.getElementById('new-back').value = '';
                ui.renderList();
                alert("ì €ì¥ ì™„ë£Œ!");
            },

            deleteCard: async (id) => {
                if(confirm('ì‚­ì œí•©ë‹ˆê¹Œ?')) {
                    cards = cards.filter(c => c.id !== id);
                    await logic.saveToDB();
                    ui.renderList();
                }
            },

            prepareStudy: () => {
                const today = new Date().toISOString().split('T')[0];
                const dueCards = cards.filter(c => c.nextReview <= today);
                if (dueCards.length > 0) {
                    currentCard = dueCards[0];
                    document.getElementById('study-content').style.display = 'block';
                    document.getElementById('no-study').style.display = 'none';
                    document.getElementById('rating-btns').style.display = 'none';
                    document.getElementById('guide-text').style.display = 'block';
                    document.getElementById('card-text').innerHTML = `<div class="front">${currentCard.front}</div>`;
                    ui.updateStats(); // ê³µë¶€ ì¤‘ ë‚¨ì€ ê°œìˆ˜ ê°±ì‹ 
                } else {
                    document.getElementById('study-content').style.display = 'none';
                    document.getElementById('no-study').style.display = 'block';
                }
            }
        };

        logic.loadCards();
    </script>
</body>
</html>

