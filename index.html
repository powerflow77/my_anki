<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ ë‹¨ì–´ì¥ (Pagination Added)</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        nav { background: white; padding: 15px 5px; display: flex; justify-content: space-around; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .nav-item { font-weight: bold; color: #aaa; cursor: pointer; padding: 10px 15px; font-size: 15px; }
        .nav-item.active { color: black; border-bottom: 2px solid black; }
        
        .container { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .screen { width: 100%; max-width: 450px; display: none; } 
        .screen.active { display: block; } 

        /* --- í†µê³„ ìŠ¤íƒ€ì¼ --- */
        .stats-container { background: white; padding: 25px 20px; border-radius: 20px; width: 100%; box-sizing: border-box; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .stat-header-row { display: flex; justify-content: space-between; border-bottom: 2px solid #f0f0f0; padding-bottom: 20px; margin-bottom: 20px; }
        .stat-header-item { text-align: center; width: 48%; }
        .stat-big-num { font-size: 32px; font-weight: bold; color: #333; display: block; line-height: 1.2; }
        .stat-caption { font-size: 13px; color: #888; font-weight: 500; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 25px; }
        .stat-box { background-color: #f9f9f9; border-radius: 12px; padding: 15px; text-align: center; }
        .stat-box-val { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .stat-box-lbl { font-size: 11px; color: #666; }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-btn { background: white; border: 1px solid #ddd; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-weight: bold; color: #555; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cal-title { font-size: 18px; font-weight: bold; color: #333; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .cal-day-name { font-size: 12px; color: #aaa; margin-bottom: 5px; font-weight: bold; }
        
        .cal-date { 
            aspect-ratio: 1/1; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            border-radius: 8px; 
            background: #f9f9f9; 
            position: relative; 
        }

        .cal-date-num { position: absolute; top: 4px; left: 5px; font-size: 10px; color: #bbb; }
        .cal-daily-count { font-size: 14px; font-weight: bold; color: #ddd; }

        .cal-date.level-1 { background-color: #e6f7ff; } 
        .cal-date.level-1 .cal-date-num { color: #8ecae6; }
        .cal-date.level-1 .cal-daily-count { color: #007bff; }

        .cal-date.level-2 { background-color: #007bff; }   
        .cal-date.level-2 .cal-date-num { color: rgba(255,255,255,0.6); }
        .cal-date.level-2 .cal-daily-count { color: white; }

        .cal-date.today { border: 2px solid #0056b3; }

        /* í•™ìŠµí•˜ê¸° íƒ­ í˜„í™©íŒ */
        .status-box { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        .stat-row { display: flex; justify-content: space-around; align-items: center; }
        .stat-item { flex: 1; }
        .stat-label { font-size: 12px; color: #888; margin-bottom: 5px; font-weight: bold; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .v-line { width: 1px; height: 40px; background: #eee; }

        /* ì…ë ¥ ë° ë¦¬ìŠ¤íŠ¸ */
        .input-area { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px;}
        
        /* input, textarea ìŠ¤íƒ€ì¼ */
        input, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; font-family: inherit; resize: vertical; }
        
        #search-input { background-color: #f9f9f9; border-color: #eee; margin-bottom: 0; }
        #search-input:focus { background-color: white; border-color: #007bff; }

        .add-btn { background: black; color: white; width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        .list-title { margin: 20px 0 10px 0; font-weight: bold; color: #555; display: flex; justify-content: space-between; align-items: center; }
        
        .card-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-info { text-align: left; width: 70%; }
        
        .card-front { font-weight: bold; font-size: 16px; color: #333; margin-bottom: 5px; white-space: pre-wrap; word-break: break-all; }
        .card-back { font-size: 14px; color: #888; white-space: pre-wrap; word-break: break-all; }
        
        .del-btn { background: #ff4d4d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; }
        .edit-btn { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; margin-right: 5px; }
        .edit-btn:hover { background: #0056b3; }

        /* ì¸ë¼ì¸ ìˆ˜ì • ëª¨ë“œ */
        .edit-input { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #007bff; border-radius: 5px; font-size: 14px; }
        .save-btn { background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; margin-right: 5px; }
        .cancel-btn { background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }

        /* [NEW] í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
        .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 20px; width: 100%; flex-wrap: wrap; }
        .page-btn { background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 8px; cursor: pointer; color: #555; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .page-btn.active { background: black; color: white; border-color: black; font-weight: bold; }
        .page-btn:disabled { opacity: 0.5; cursor: default; }

        /* ê³µë¶€ ì¹´ë“œ */
        .card { 
            background: white; 
            border-radius: 20px; 
            padding: 40px 20px; 
            min-height: 300px; 
            width: 100%; 
            box-sizing: border-box;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            margin-bottom: 20px; 
            position: relative; 
        }
        .front { font-size: 30px; font-weight: bold; color: #333; white-space: pre-wrap; word-break: break-all; }
        .back { font-size: 24px; color: #007bff; margin-top: 30px; font-weight: bold; white-space: pre-wrap; word-break: break-all; }
        
        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 8px; width: 100%; }
        .btn-group button { flex: 1; padding: 12px 5px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 13px; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .btn-group button:active { transform: scale(0.95); }

        /* Undo ë²„íŠ¼ */
        .undo-btn { 
            margin-top: 15px; 
            background: #6c757d; 
            color: white; 
            border: none; 
            padding: 8px 20px; 
            border-radius: 20px; 
            font-size: 14px; 
            cursor: pointer; 
            display: none; 
        }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:999; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px; color: #333; }
    </style>
</head>
<body>

    <div id="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>

    <nav>
        <div id="tab-manage" class="nav-item active" onclick="ui.switchTab('manage')">ì¹´ë“œê´€ë¦¬</div>
        <div id="tab-study" class="nav-item" onclick="ui.switchTab('study')">í•™ìŠµí•˜ê¸°</div>
        <div id="tab-stats" class="nav-item" onclick="ui.switchTab('stats')">í†µê³„</div>
    </nav>

    <div class="container">
        <div id="view-manage" class="screen active">
            <div class="input-area">
                <h3 style="margin-top:0; font-size:18px;">ìƒˆ ì¹´ë“œ ì¶”ê°€</h3>
                <textarea id="new-front" placeholder="ì•ë©´ (ì§ˆë¬¸/ì˜ì–´) - ì—”í„°ë¡œ ì¤„ë°”ê¿ˆ" rows="2" onkeydown="if(event.shiftKey && event.key === 'Enter') logic.addCard()"></textarea>
                <textarea id="new-back" placeholder="ë’·ë©´ (ì •ë‹µ/í•œê¸€) - ì—”í„°ë¡œ ì¤„ë°”ê¿ˆ" rows="2" onkeydown="if(event.shiftKey && event.key === 'Enter') logic.addCard()"></textarea>
                <button class="add-btn" onclick="logic.addCard()">ì €ì¥í•˜ê¸°</button>
            </div>
            
            <div style="width:100%; margin-bottom:10px;">
                <input type="text" id="search-input" placeholder="ğŸ” ë‹¨ì–´ ê²€ìƒ‰ (ì•ë©´/ë’·ë©´)" onkeyup="ui.searchReset()" style="margin:0;">
            </div>

            <div class="list-title"><span>ì„œë²„ ì €ì¥ ëª©ë¡</span> <button onclick="logic.loadCards()" style="background:none; border:none; color:blue; cursor:pointer;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button></div>
            
            <div id="card-list-area"></div>
            <div id="pagination-area" class="pagination"></div>
        </div>

        <div id="view-study" class="screen">
            <div class="status-box">
                <div class="stat-row">
                    <div class="stat-item">
                        <div class="stat-label">NEW</div>
                        <div id="study-new" class="stat-value" style="color:#007bff;">0</div>
                    </div>
                    <div class="v-line"></div>
                    <div class="stat-item">
                        <div class="stat-label">REVIEW</div>
                        <div id="study-rev" class="stat-value" style="color:#28a745;">0</div>
                    </div>
                    <div class="v-line"></div>
                    <div class="stat-item">
                        <div class="stat-label">TOTAL</div>
                        <div id="study-total" class="stat-value" style="color:#333;">0</div>
                    </div>
                </div>
            </div>

            <div id="study-content" style="display:none; width:100%;">
                <div id="card-display" class="card" onclick="ui.flipCard()">
                    <div id="card-text">ë¡œë”© ì¤‘...</div>
                </div>
                <p id="guide-text" style="color:#888; text-align:center;">í„°ì¹˜í•´ì„œ ì •ë‹µ í™•ì¸</p>
                <div id="rating-btns" class="btn-group" style="display: none;">
                    <button id="btn-1" style="background:#ffadad" onclick="logic.rateCard(1)">Again</button>
                    <button id="btn-3" style="background:#ffd6a5" onclick="logic.rateCard(3)">Hard</button>
                    <button id="btn-4" style="background:#fdffb6" onclick="logic.rateCard(4)">Good</button>
                    <button id="btn-5" style="background:#caffbf" onclick="logic.rateCard(5)">Easy</button>
                </div>

                <div style="text-align: center;">
                    <button id="btn-undo" class="undo-btn" onclick="logic.undoLastAction()">â†©ï¸ ì‹¤í–‰ ì·¨ì†Œ</button>
                </div>
            </div>
            
            <div id="no-study" style="text-align: center; display: block;">
                <h2>ğŸ‰</h2><h3>ì˜¤ëŠ˜ ê³µë¶€ ë!</h3><p>ë³µìŠµí•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <button class="add-btn" onclick="ui.switchTab('stats')">ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
            </div>
        </div>

        <div id="view-stats" class="screen">
            <h3 style="margin-top:0; color:#333;">ğŸ“Š í•™ìŠµ ë¦¬í¬íŠ¸</h3>
            
            <div class="stats-container">
                <div class="stat-header-row">
                    <div class="stat-header-item">
                        <span id="txt-total-count" class="stat-big-num">0</span>
                        <span class="stat-caption">ì´ ëˆ„ì  í•™ìŠµ</span>
                    </div>
                    <div class="stat-header-item">
                        <span id="txt-streak-count" class="stat-big-num" style="color:#ff6b6b">0</span>
                        <span class="stat-caption">ì—°ì† í•™ìŠµì¼</span>
                    </div>
                </div>

                <div class="stat-grid">
                    <div class="stat-box">
                        <div id="txt-mature" class="stat-box-val" style="color:#28a745;">0ê°œ</div>
                        <div class="stat-box-lbl">ì™„ì „ ì•”ê¸° (21ì¼â†‘)</div>
                    </div>
                    <div class="stat-box">
                        <div id="txt-avg-int" class="stat-box-val" style="color:#007bff;">0ì¼</div>
                        <div class="stat-box-lbl">í‰ê·  ê¸°ì–µ ìˆ˜ëª…</div>
                    </div>
                    <div class="stat-box">
                        <div id="txt-difficulty" class="stat-box-val" style="color:#fd7e14;">100%</div>
                        <div class="stat-box-lbl">ë‡Œ ê³ í†µ ì§€ìˆ˜</div>
                    </div>
                    <div class="stat-box">
                        <div id="txt-tomorrow" class="stat-box-val" style="color:#6f42c1;">0ê°œ</div>
                        <div class="stat-box-lbl">ë‚´ì¼ì˜ ì§</div>
                    </div>
                </div>

                <div class="calendar-header">
                    <button class="cal-btn" onclick="logic.changeMonth(-1)"> < </button>
                    <span id="cal-month-title" class="cal-title">2025.12</span>
                    <button class="cal-btn" onclick="logic.changeMonth(1)"> > </button>
                </div>

                <div class="calendar-grid" id="calendar-area"></div>
                
                <div style="text-align:center; margin-top:15px; font-size:13px; color:#888;">
                    í•´ë‹¹ ì›” í•™ìŠµëŸ‰: <span id="cal-month-total" style="font-weight:bold; color:#007bff;">0íšŒ</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBaf_WMp-HO061x8di3e2Z_bFrSytngQGA",
            authDomain: "anki-27849.firebaseapp.com",
            projectId: "anki-27849",
            storageBucket: "anki-27849.firebasestorage.app",
            messagingSenderId: "3948908398",
            appId: "1:3948908398:web:65ee16620c4caee6d03b7f",
            measurementId: "G-19J7ZJVV0S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const DOC_ID = "my_cards_data";

        let cards = [];
        let history = {};
        let currentCard = null;
        let viewDate = new Date(); 
        let backupState = null;
        
        // [NEW] í˜ì´ì§€ë„¤ì´ì…˜ ë³€ìˆ˜
        let currentPage = 1;
        const ITEMS_PER_PAGE = 20;

        window.ui = {
            switchTab: (tabName) => {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tabName}`).classList.add('active');
                document.getElementById(`view-${tabName}`).classList.add('active');
                
                if (tabName === 'study') logic.prepareStudy();
                if (tabName === 'stats') logic.renderCalendarStats(); 
            },

            flipCard: () => {
                if (!currentCard) return;
                document.getElementById('card-text').innerHTML = `<div class="front">${currentCard.front}</div><div class="back">${currentCard.back}</div>`;
                document.getElementById('rating-btns').style.display = 'flex';
                document.getElementById('guide-text').style.display = 'none';
                logic.updateButtonLabels(); 
            },

            // [NEW] ê²€ìƒ‰ ì‹œ í˜ì´ì§€ ì´ˆê¸°í™”
            searchReset: () => {
                currentPage = 1;
                ui.renderList();
            },

            // [NEW] í˜ì´ì§€ ë³€ê²½ í•¨ìˆ˜
            changePage: (page) => {
                currentPage = page;
                ui.renderList();
            },

            renderList: () => {
                const listArea = document.getElementById('card-list-area');
                const pagArea = document.getElementById('pagination-area');
                listArea.innerHTML = '';
                pagArea.innerHTML = '';

                const query = document.getElementById('search-input') ? document.getElementById('search-input').value.toLowerCase() : "";
                
                // 1. í•„í„°ë§
                let filtered = cards.filter(c => c.front.toLowerCase().includes(query) || c.back.toLowerCase().includes(query));
                
                // 2. ìµœì‹ ìˆœ ì •ë ¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                filtered = filtered.reverse();

                // 3. í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
                const totalItems = filtered.length;
                const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE) || 1;
                if (currentPage > totalPages) currentPage = totalPages;

                const start = (currentPage - 1) * ITEMS_PER_PAGE;
                const end = start + ITEMS_PER_PAGE;
                const pageData = filtered.slice(start, end);

                // 4. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (20ê°œë§Œ)
                pageData.forEach(card => {
                    const div = document.createElement('div');
                    div.id = `card-wrap-${card.id}`; 
                    div.className = 'card-item';
                    div.innerHTML = `
                        <div class="card-info">
                            <div class="card-front">${card.front}</div>
                            <div class="card-back">${card.back}</div>
                        </div>
                        <div style="display:flex; flex-shrink:0;">
                            <button class="edit-btn" onclick="logic.toggleEditMode(${card.id})">ìˆ˜ì •</button>
                            <button class="del-btn" onclick="logic.deleteCard(${card.id})">ì‚­ì œ</button>
                        </div>
                    `;
                    listArea.appendChild(div);
                });

                // 5. í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ë Œë”ë§
                if (totalPages > 1) {
                    let pagHTML = '';
                    
                    // ì´ì „ ë²„íŠ¼
                    pagHTML += `<button class="page-btn" onclick="ui.changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lt;</button>`;
                    
                    // ìˆ«ì ë²„íŠ¼ (ë‹¨ìˆœí™”: ì „ì²´ ë‹¤ ë³´ì—¬ì£¼ê±°ë‚˜ ì ë‹¹íˆ ìë¥´ê¸°. ì¼ë‹¨ ì‹¬í”Œí•˜ê²Œ 1~Total)
                    // ì¹¸ì´ ì¢ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìµœëŒ€ 5ê°œ ì •ë„ë§Œ ë³´ì—¬ì£¼ëŠ” ë¡œì§ì´ ì¢‹ì§€ë§Œ, ìš”ì²­ì‚¬í•­ëŒ€ë¡œ ë‹¨ìˆœ 20ê°œ ëŠê¸° êµ¬í˜„ì— ì§‘ì¤‘.
                    // ëª¨ë°”ì¼ í™”ë©´ ê³ ë ¤í•˜ì—¬ ì‹¬í”Œí•˜ê²Œ í˜„ì¬ í˜ì´ì§€ ì£¼ë³€ë§Œ ë³´ì—¬ì£¼ê² ìŠµë‹ˆë‹¤.
                    
                    let startPage = Math.max(1, currentPage - 2);
                    let endPage = Math.min(totalPages, startPage + 4);
                    if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

                    for (let i = startPage; i <= endPage; i++) {
                        pagHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="ui.changePage(${i})">${i}</button>`;
                    }

                    // ë‹¤ìŒ ë²„íŠ¼
                    pagHTML += `<button class="page-btn" onclick="ui.changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&gt;</button>`;
                    
                    pagArea.innerHTML = pagHTML;
                }
            },

            updateStudyDashboard: () => {
                const today = logic.getTodayStr(); 
                const dueCards = cards.filter(c => c.nextReview <= today);
                const newCount = dueCards.filter(c => c.repetitions === 0).length;
                const revCount = dueCards.filter(c => c.repetitions > 0).length;
                
                document.getElementById('study-new').innerText = newCount;
                document.getElementById('study-rev').innerText = revCount;
                document.getElementById('study-total').innerText = cards.length;
            }
        };

        window.logic = {
            getTodayStr: () => {
                const d = new Date();
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            
            formatDate: (d) => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            toggleEditMode: (id) => {
                const card = cards.find(c => c.id === id);
                if (!card) return;
                const wrap = document.getElementById(`card-wrap-${id}`);
                // [ìœ ì§€] textarea + Shift Enter
                wrap.innerHTML = `
                    <div style="width:100%;">
                        <textarea id="edit-front-${id}" class="edit-input" rows="3" onkeydown="if(event.shiftKey && event.key === 'Enter') logic.saveEdit(${id})">${card.front}</textarea>
                        <textarea id="edit-back-${id}" class="edit-input" rows="3" onkeydown="if(event.shiftKey && event.key === 'Enter') logic.saveEdit(${id})">${card.back}</textarea>
                        <div style="text-align:right;">
                            <button class="save-btn" onclick="logic.saveEdit(${id})">ì €ì¥</button>
                            <button class="cancel-btn" onclick="ui.renderList()">ì·¨ì†Œ</button>
                        </div>
                    </div>
                `;
            },

            saveEdit: async (id) => {
                const newFront = document.getElementById(`edit-front-${id}`).value;
                const newBack = document.getElementById(`edit-back-${id}`).value;
                if (!newFront || !newBack) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                const card = cards.find(c => c.id === id);
                if (card) {
                    card.front = newFront;
                    card.back = newBack;
                    await logic.saveToDB();
                    ui.renderList();
                }
            },

            renderCalendarStats: () => {
                const total = Object.values(history).reduce((a, b) => a + b, 0);
                document.getElementById('txt-total-count').innerText = total + "íšŒ";

                let streak = 0;
                let d = new Date(); 
                while(true) {
                    const dateStr = logic.formatDate(d);
                    if ((history[dateStr] || 0) > 0) {
                        streak++;
                        d.setDate(d.getDate() - 1);
                    } else { break; }
                }
                document.getElementById('txt-streak-count').innerText = streak + "ì¼";

                const matureCount = cards.filter(c => c.interval >= 21).length;
                document.getElementById('txt-mature').innerText = matureCount + "ê°œ";
                
                const totalInt = cards.reduce((acc, c) => acc + c.interval, 0);
                const avgInt = cards.length > 0 ? Math.round(totalInt / cards.length) : 0;
                document.getElementById('txt-avg-int').innerText = avgInt + "ì¼";
                
                const totalEase = cards.reduce((acc, c) => acc + c.easeFactor, 0);
                const avgEase = cards.length > 0 ? (totalEase / cards.length) : 2.5;
                const difficulty = Math.round((avgEase / 2.5) * 100);
                document.getElementById('txt-difficulty').innerText = difficulty + "%";
                
                const tmr = new Date();
                tmr.setDate(tmr.getDate() + 1);
                const tmrStr = logic.formatDate(tmr);
                const tmrDue = cards.filter(c => c.nextReview === tmrStr).length;
                document.getElementById('txt-tomorrow').innerText = tmrDue + "ê°œ";

                const year = viewDate.getFullYear();
                const month = viewDate.getMonth(); 
                document.getElementById('cal-month-title').innerText = `${year}.${String(month+1).padStart(2,'0')}`;

                const calArea = document.getElementById('calendar-area');
                calArea.innerHTML = '';

                const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
                days.forEach(d => calArea.innerHTML += `<div class="cal-day-name">${d}</div>`);

                const firstDay = new Date(year, month, 1).getDay(); 
                const lastDate = new Date(year, month + 1, 0).getDate(); 

                for(let i=0; i<firstDay; i++) {
                    calArea.innerHTML += `<div></div>`;
                }

                let monthTotal = 0;
                const todayStr = logic.getTodayStr(); 

                for(let i=1; i<=lastDate; i++) {
                    const dateObj = new Date(year, month, i);
                    const dateKey = logic.formatDate(dateObj);

                    const count = history[dateKey] || 0;
                    if(count > 0) monthTotal += count;

                    let classes = 'cal-date';
                    if (dateKey === todayStr) classes += ' today';
                    if (count > 0) classes += ' level-1';
                    if (count >= 10) classes += ' level-2';

                    calArea.innerHTML += `
                        <div class="${classes}">
                            <span class="cal-date-num">${i}</span>
                            <span class="cal-daily-count">${count}</span>
                        </div>
                    `;
                }
                
                document.getElementById('cal-month-total').innerText = monthTotal + "íšŒ";
            },

            changeMonth: (delta) => {
                viewDate.setMonth(viewDate.getMonth() + delta);
                logic.renderCalendarStats();
            },

            formatInterval: (days) => {
                if (days === 0) return "10ë¶„";
                if (days >= 365) return (days / 365).toFixed(1) + "ë…„";
                if (days >= 30) return (days / 30).toFixed(1) + "ë‹¬";
                return days + "ì¼";
            },

            calculateNext: (quality) => {
                let { interval, repetitions, easeFactor } = currentCard;
                let newInt = interval;
                let newReps = repetitions;
                let newEase = easeFactor;

                if (quality === 1) { 
                    newReps = 0;
                    newInt = 0; 
                } else {
                    if (newReps === 0) newInt = (quality === 5) ? 4 : 1;
                    else if (newReps === 1) newInt = 6;
                    else {
                        let modifier = (quality === 3) ? 1.2 : (quality === 5 ? 1.3 : 1.0);
                        newInt = Math.round(newInt * newEase * modifier);
                    }
                    newReps++;
                }

                if (quality !== 1) {
                    newEase += (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                    if (newEase < 1.3) newEase = 1.3;
                }
                return { interval: newInt, repetitions: newReps, easeFactor: newEase };
            },

            updateButtonLabels: () => {
                const labels = { 1: "Again", 3: "Hard", 4: "Good", 5: "Easy" };
                [1, 3, 4, 5].forEach(q => {
                    const res = logic.calculateNext(q);
                    const timeText = logic.formatInterval(res.interval);
                    document.getElementById(`btn-${q}`).innerText = `${labels[q]} (${timeText})`;
                });
            },

            undoLastAction: async () => {
                if (!backupState) return alert("ì‹¤í–‰ ì·¨ì†Œí•  ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.");
                cards = JSON.parse(JSON.stringify(backupState.cards));
                history = JSON.parse(JSON.stringify(backupState.history));
                backupState = null;
                document.getElementById('btn-undo').style.display = 'none';
                await logic.saveToDB();
                logic.prepareStudy();
            },

            rateCard: async (quality) => {
                backupState = {
                    cards: JSON.parse(JSON.stringify(cards)),
                    history: JSON.parse(JSON.stringify(history))
                };
                document.getElementById('btn-undo').style.display = 'inline-block';

                const res = logic.calculateNext(quality);
                currentCard.interval = res.interval;
                currentCard.repetitions = res.repetitions;
                currentCard.easeFactor = res.easeFactor;
                
                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + res.interval);
                currentCard.nextReview = logic.formatDate(nextDate); 

                if (quality === 1) {
                    cards = cards.filter(c => c.id !== currentCard.id);
                    cards.push(currentCard);
                }

                const today = logic.getTodayStr(); 
                if (!history[today]) history[today] = 0;
                history[today]++;

                await logic.saveToDB();
                logic.prepareStudy();
            },

            loadCards: async () => {
                document.getElementById('loading').style.display = 'flex';
                try {
                    const docSnap = await getDoc(doc(db, "anki", DOC_ID));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        cards = data.list || [];
                        history = data.history || {};
                    } else {
                        cards = [];
                        history = {};
                    }
                    ui.renderList(); // ì—¬ê¸°ì„œ í˜ì´ì§€ë„¤ì´ì…˜ ìµœì´ˆ ì ìš©ë¨
                    ui.updateStudyDashboard();
                } catch (e) { alert("ë¡œë“œ ì—ëŸ¬: " + e.message); }
                document.getElementById('loading').style.display = 'none';
            },

            saveToDB: async () => {
                await setDoc(doc(db, "anki", DOC_ID), { list: cards, history: history });
                ui.updateStudyDashboard();
            },

            addCard: async () => {
                const f = document.getElementById('new-front').value;
                const b = document.getElementById('new-back').value;
                if (!f || !b) return alert('ì…ë ¥í•˜ì„¸ìš”!');
                cards.push({ id: Date.now(), front: f, back: b, interval: 0, repetitions: 0, easeFactor: 2.5, nextReview: logic.getTodayStr() });
                await logic.saveToDB();
                document.getElementById('new-front').value = '';
                document.getElementById('new-back').value = '';
                document.getElementById('search-input').value = ''; 
                
                // [NEW] ì¹´ë“œ ì¶”ê°€ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™í•´ì„œ ë‚´ ì¹´ë“œ í™•ì¸
                currentPage = 1; 
                ui.renderList();
                alert("ì €ì¥ ì™„ë£Œ!");
            },

            deleteCard: async (id) => {
                if(confirm('ì‚­ì œí•©ë‹ˆê¹Œ?')) {
                    cards = cards.filter(c => c.id !== id);
                    await logic.saveToDB();
                    ui.renderList();
                }
            },

            prepareStudy: () => {
                const today = logic.getTodayStr();
                ui.updateStudyDashboard(); 
                const dueCards = cards.filter(c => c.nextReview <= today);
                if (dueCards.length > 0) {
                    currentCard = dueCards[0];
                    document.getElementById('study-content').style.display = 'block';
                    document.getElementById('no-study').style.display = 'none';
                    document.getElementById('rating-btns').style.display = 'none';
                    document.getElementById('guide-text').style.display = 'block';
                    document.getElementById('card-text').innerHTML = `<div class="front">${currentCard.front}</div>`;
                } else {
                    document.getElementById('study-content').style.display = 'none';
                    document.getElementById('no-study').style.display = 'block';
                }
            }
        };

        logic.loadCards();
    </script>
</body>
</html>
