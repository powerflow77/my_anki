<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki Pro (Ultimate Stats)</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ */
        nav { background: white; padding: 15px 5px; display: flex; justify-content: space-around; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .nav-item { font-weight: bold; color: #aaa; cursor: pointer; padding: 5px 10px; font-size: 15px; flex: 1; text-align: center; }
        .nav-item.active { color: black; border-bottom: 2px solid black; }
        
        /* ì»¨í…Œì´ë„ˆ */
        .container { flex: 1; padding: 15px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .screen { width: 100%; max-width: 600px; display: none; } 
        .screen.active { display: block; } 
        
        /* ì¹´ë“œ ë°•ìŠ¤ */
        .card-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; width: 100%; box-sizing: border-box; }
        input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .add-btn { background: black; color: white; width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        .card-item { 
            background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        .card-text-group { flex-grow: 1; overflow: hidden; }
        .card-btn-group { display: flex; gap: 6px; flex-shrink: 0; white-space: nowrap; }

        .mini-btn { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; color: white; }
        .edit-btn { background: #4a90e2; }
        .del-btn { background: #ff4d4d; }
        .save-btn { background: #2ecc71; }
        .cancel-btn { background: #aaa; }

        /* í†µê³„ ê·¸ë¦¬ë“œ (KPI ë³µêµ¬ë¨) */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; width: 100%; }
        .kpi-card { background: white; padding: 20px 15px; border-radius: 12px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .kpi-value { display: block; font-size: 26px; font-weight: 800; color: #333; margin-bottom: 5px; }
        .kpi-label { font-size: 13px; color: #888; font-weight: 600; }
        .kpi-sub { font-size: 11px; color: #aaa; margin-top: 5px; } /* ì„œë¸Œ í…ìŠ¤íŠ¸ ë³µêµ¬ */
        
        /* ìƒì„¸ í†µê³„ í…Œì´ë¸” */
        .stat-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .stat-table th { text-align: left; color: #888; padding: 10px 0; border-bottom: 1px solid #eee; }
        .stat-table td { text-align: right; font-weight: bold; padding: 10px 0; border-bottom: 1px solid #eee; color: #333; }
        .stat-table tr:last-child th, .stat-table tr:last-child td { border-bottom: none; }

        /* í•™ìŠµ ì¹´ë“œ */
        .card { background: white; border-radius: 15px; padding: 40px 20px; min-height: 250px; width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.05); cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; margin-bottom: 20px; box-sizing: border-box; }
        .front { font-size: 26px; font-weight: bold; color: #333; line-height: 1.4; }
        .back { font-size: 20px; color: #007bff; margin-top: 20px; font-weight: bold; line-height: 1.4; }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:999; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #333; }
        
        .txt-blue { color: #007bff; }
        .txt-red { color: #ff4d4d; }
        .txt-green { color: #2ecc71; }
        .txt-fire { color: #ff9f43; }
    </style>
</head>
<body>

    <div id="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>

    <nav>
        <div id="tab-manage" class="nav-item active" onclick="ui.switchTab('manage')">ì¹´ë“œê´€ë¦¬</div>
        <div id="tab-study" class="nav-item" onclick="ui.switchTab('study')">ë‹¨ì–´ê³µë¶€</div>
        <div id="tab-stats" class="nav-item" onclick="ui.switchTab('stats')">ë¶„ì„ì‹¤</div>
    </nav>

    <div class="container">
        <div id="view-manage" class="screen active">
            <div class="card-box" style="text-align: center; padding: 15px;">
                <span style="font-size: 14px; color: #666;">ë³µìŠµ ëŒ€ê¸°:</span>
                <span id="due-count" style="font-weight:bold; color:#ff4d4d; font-size:20px; margin-left: 5px;">0</span>
            </div>
            
            <div class="card-box">
                <input type="text" id="new-front" placeholder="ì•ë©´ (ìƒí™©/í•œêµ­ì–´)">
                <input type="text" id="new-back" placeholder="ë’·ë©´ (ì˜ì–´ í‘œí˜„)">
                <button class="add-btn" onclick="logic.addCard()">ì¶”ê°€í•˜ê¸°</button>
            </div>

            <div id="card-list-area"></div>
            
            <div style="display:flex; justify-content:center; gap:20px; margin-top:10px; padding-bottom:30px;">
                <button onclick="logic.changePage(-1)" id="prev-btn" style="padding:10px 20px; border:1px solid #ddd; background:white; border-radius:8px;">ì´ì „</button>
                <span id="page-info" style="align-self:center; font-weight:bold; color:#666;">1 / 1</span>
                <button onclick="logic.changePage(1)" id="next-btn" style="padding:10px 20px; border:1px solid #ddd; background:white; border-radius:8px;">ë‹¤ìŒ</button>
            </div>
        </div>

        <div id="view-study" class="screen">
            <div id="study-content" style="display:none; width:100%;">
                <div id="card-display" class="card" onclick="ui.flipCard()">
                    <div id="card-text">ì¹´ë“œ ë¡œë”© ì¤‘...</div>
                </div>
                <div id="rating-btns" style="display: none; gap: 10px; width: 100%;">
                    <button style="flex:1; padding:15px; background:#ffadad; border:none; border-radius:10px; font-weight:bold; font-size:16px;" onclick="logic.rateCard(1)">Again</button>
                    <button style="flex:1; padding:15px; background:#caffbf; border:none; border-radius:10px; font-weight:bold; font-size:16px;" onclick="logic.rateCard(5)">Easy</button>
                </div>
            </div>
            <div id="no-study" style="text-align: center; display: block;">
                <h1 style="font-size: 40px; margin-bottom: 5px;">ğŸ”¥</h1>
                <h3>ì˜¤ëŠ˜ ë¶„ëŸ‰ ë!</h3>
                <p style="color:#666;">ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤.</p>
                <button class="add-btn" onclick="ui.switchTab('stats')">ê¸°ë¡ í™•ì¸í•˜ê¸°</button>
            </div>
        </div>

        <div id="view-stats" class="screen">
            <h3 style="margin: 0 0 10px 0; color:#444;">ì˜¤ëŠ˜ì˜ í™œë™</h3>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <span id="kpi-streak" class="kpi-value txt-fire">0ì¼</span>
                    <span class="kpi-label">ì—°ì† í•™ìŠµ ğŸ”¥</span>
                </div>
                <div class="kpi-card">
                    <span id="kpi-today-count" class="kpi-value txt-blue">0</span>
                    <span class="kpi-label">ì˜¤ëŠ˜ ë³µìŠµëŸ‰</span>
                </div>
            </div>

            <h3 style="margin: 15px 0 10px 0; color:#444;">ë‡Œ êµ¬ì¡° ë¶„ì„</h3>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <span id="kpi-total" class="kpi-value">0</span>
                    <span class="kpi-label">ì´ ì €ì¥ ë¬¸ì¥</span>
                </div>
                <div class="kpi-card">
                    <span id="kpi-mature" class="kpi-value txt-green">0%</span>
                    <span class="kpi-label">ì™„ì „ ì•”ê¸°ìœ¨</span>
                    <div class="kpi-sub">21ì¼ ì´ìƒ ê¸°ì–µ</div>
                </div>
                <div class="kpi-card">
                    <span id="kpi-avg-ivl" class="kpi-value">0ì¼</span>
                    <span class="kpi-label">í‰ê·  ê¸°ì–µ ìˆ˜ëª…</span>
                    <div class="kpi-sub">ê¸¸ìˆ˜ë¡ ì¢‹ìŒ</div>
                </div>
                <div class="kpi-card">
                    <span id="kpi-leech" class="kpi-value txt-red">0</span>
                    <span class="kpi-label">ì§€ì˜¥ì˜ ì¹´ë“œ</span>
                    <div class="kpi-sub">ìì£¼ í‹€ë¦¼</div>
                </div>
            </div>

            <div class="card-box">
                <h4 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“… ìµœê·¼ 7ì¼ í•™ìŠµëŸ‰</h4>
                <table class="stat-table" id="daily-log-table">
                    <tr><td style="text-align:center; color:#888;">ê¸°ë¡ ë¡œë”© ì¤‘...</td></tr>
                </table>
            </div>

            <div class="card-box">
                <h4 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ§  ê¸°ì–µ ë‹¨ê³„ ë¶„í¬</h4>
                <table class="stat-table">
                    <tr><th>ğŸ”´ ì‹ ê·œ/ì¬í•™ìŠµ</th><td id="st-new">0ê°œ</td></tr>
                    <tr><th>ğŸŸ  ë‹¨ê¸° ê¸°ì–µ</th><td id="st-short">0ê°œ</td></tr>
                    <tr><th>ğŸŸ¡ ì¤‘ê¸° ê¸°ì–µ</th><td id="st-mid">0ê°œ</td></tr>
                    <tr><th>ğŸŸ¢ ì¥ê¸° ê¸°ì–µ</th><td id="st-long">0ê°œ</td></tr>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBaf_WMp-HO061x8di3e2Z_bFrSytngQGA",
            authDomain: "anki-27849.firebaseapp.com",
            projectId: "anki-27849",
            storageBucket: "anki-27849.firebasestorage.app",
            messagingSenderId: "3948908398",
            appId: "1:3948908398:web:65ee16620c4caee6d03b7f",
            measurementId: "G-19J7ZJVV0S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const DOC_ID = "my_cards_data";

        let cards = [];
        let studyLog = {}; 
        let currentCard = null;
        let currentPage = 1;
        const PAGE_SIZE = 20;
        let editingCardId = null;

        // â˜… ë¡œì»¬ íƒ€ì„(KST) ì™„ë²½ íŒ¨ì¹˜
        const getTodayStr = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getDayLabel = (dateStr) => {
            const date = new Date(dateStr);
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return `${date.getMonth()+1}/${date.getDate()} (${days[date.getDay()]})`;
        };

        window.ui = {
            switchTab: (tabName) => {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tabName}`).classList.add('active');
                document.getElementById(`view-${tabName}`).classList.add('active');
                if (tabName === 'study') logic.prepareStudy();
                if (tabName === 'stats') ui.renderStats();
            },
            flipCard: () => {
                if (!currentCard) return;
                document.getElementById('card-text').innerHTML = `<div class="front">${currentCard.front}</div><div class="back">${currentCard.back}</div>`;
                document.getElementById('rating-btns').style.display = 'flex';
            },
            renderList: () => {
                const listArea = document.getElementById('card-list-area');
                listArea.innerHTML = '';
                const reversed = [...cards].reverse();
                const totalPages = Math.ceil(cards.length / PAGE_SIZE) || 1;
                const paged = reversed.slice((currentPage-1)*PAGE_SIZE, currentPage*PAGE_SIZE);

                paged.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'card-item';
                    
                    if(editingCardId === card.id) {
                        div.innerHTML = `
                            <div style="width:100%;">
                                <input id="ef-${card.id}" value="${card.front}" style="margin-bottom:5px;">
                                <input id="eb-${card.id}" value="${card.back}" style="margin-bottom:10px;">
                                <div style="display:flex; gap:5px;">
                                    <button class="mini-btn save-btn" style="flex:1;" onclick="logic.updateCard(${card.id})">ì €ì¥</button>
                                    <button class="mini-btn cancel-btn" style="flex:1;" onclick="logic.startEdit(null)">ì·¨ì†Œ</button>
                                </div>
                            </div>`;
                    } else {
                        div.innerHTML = `
                            <div class="card-text-group">
                                <div style="font-weight:bold; color:#333; margin-bottom:4px; font-size:16px;">${card.front}</div>
                                <div style="color:#666; font-size:14px;">${card.back}</div>
                            </div>
                            <div class="card-btn-group">
                                <button class="mini-btn edit-btn" onclick="logic.startEdit(${card.id})">ìˆ˜ì •</button>
                                <button class="mini-btn del-btn" onclick="logic.deleteCard(${card.id})">ì‚­ì œ</button>
                            </div>`;
                    }
                    listArea.appendChild(div);
                });
                document.getElementById('page-info').innerText = `${currentPage} / ${totalPages}`;
            },
            renderStats: () => {
                const todayStr = getTodayStr();
                const total = cards.length;

                // 1. KPI ê³„ì‚° (ë³µêµ¬ë¨)
                const matureCnt = cards.filter(c => c.interval > 21).length;
                const matureRate = total > 0 ? Math.round((matureCnt / total) * 100) : 0;
                const avgIvl = total > 0 ? Math.round(cards.reduce((acc, c) => acc + c.interval, 0) / total) : 0;
                const leeches = cards.filter(c => c.easeFactor < 1.5).length;

                document.getElementById('kpi-total').innerText = total;
                document.getElementById('kpi-mature').innerText = `${matureRate}%`;
                document.getElementById('kpi-avg-ivl').innerText = `${avgIvl}ì¼`;
                document.getElementById('kpi-leech').innerText = leeches;

                // 2. ì—°ì† í•™ìŠµì¼(Streak) ë° ë¡œê·¸ í…Œì´ë¸”
                let tableHtml = '';
                let streak = 0;
                
                let streakCursor = new Date(); 
                if (!studyLog[getTodayStr()]) {
                    streakCursor.setDate(streakCursor.getDate() - 1);
                }

                while(true) {
                    const y = streakCursor.getFullYear();
                    const m = String(streakCursor.getMonth() + 1).padStart(2,'0');
                    const d = String(streakCursor.getDate()).padStart(2,'0');
                    const sStr = `${y}-${m}-${d}`;

                    if(studyLog[sStr] && studyLog[sStr] > 0) {
                        streak++;
                        streakCursor.setDate(streakCursor.getDate() - 1);
                    } else {
                        break;
                    }
                }

                for (let i = 0; i < 7; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2,'0');
                    const day = String(d.getDate()).padStart(2,'0');
                    const dStr = `${y}-${m}-${day}`;

                    const count = studyLog[dStr] || 0;
                    const label = (i === 0) ? "ì˜¤ëŠ˜" : getDayLabel(dStr);
                    const colorStyle = count > 0 ? 'color:#007bff;' : 'color:#ddd;';
                    
                    tableHtml += `<tr>
                        <th>${label}</th>
                        <td style="${colorStyle} font-size:16px;">${count}íšŒ</td>
                    </tr>`;
                }

                document.getElementById('daily-log-table').innerHTML = tableHtml;
                document.getElementById('kpi-streak').innerText = `${streak}ì¼`;
                document.getElementById('kpi-today-count').innerText = studyLog[todayStr] || 0;

                // 3. ê¸°ì–µ ë¶„í¬
                const ivls = [0, 0, 0, 0];
                cards.forEach(c => {
                    if (c.interval <= 1) ivls[0]++;
                    else if (c.interval <= 7) ivls[1]++;
                    else if (c.interval <= 30) ivls[2]++;
                    else ivls[3]++;
                });
                document.getElementById('st-new').innerText = `${ivls[0]}ê°œ`;
                document.getElementById('st-short').innerText = `${ivls[1]}ê°œ`;
                document.getElementById('st-mid').innerText = `${ivls[2]}ê°œ`;
                document.getElementById('st-long').innerText = `${ivls[3]}ê°œ`;
            }
        };

        window.logic = {
            loadCards: async () => {
                document.getElementById('loading').style.display = 'flex';
                try {
                    const docSnap = await getDoc(doc(db, "anki", DOC_ID));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        cards = data.list || [];
                        studyLog = data.studyLog || {};
                    } else {
                        cards = [];
                        studyLog = {};
                    }
                    ui.renderList();
                    document.getElementById('due-count').innerText = cards.filter(c => c.nextReview <= getTodayStr()).length;
                } catch(e) { console.error(e); }
                document.getElementById('loading').style.display = 'none';
            },
            saveToDB: async () => {
                await setDoc(doc(db, "anki", DOC_ID), { list: cards, studyLog: studyLog });
                ui.renderList();
                document.getElementById('due-count').innerText = cards.filter(c => c.nextReview <= getTodayStr()).length;
            },
            addCard: async () => {
                const f = document.getElementById('new-front').value;
                const b = document.getElementById('new-back').value;
                if(!f || !b) return;
                cards.push({ id: Date.now(), front: f, back: b, interval: 0, repetitions: 0, easeFactor: 2.5, nextReview: getTodayStr(), lastReviewDate: '' });
                await logic.saveToDB();
                document.getElementById('new-front').value = ''; document.getElementById('new-back').value = '';
            },
            startEdit: (id) => { editingCardId = id; ui.renderList(); },
            updateCard: async (id) => {
                const card = cards.find(c => c.id === id);
                card.front = document.getElementById(`ef-${id}`).value;
                card.back = document.getElementById(`eb-${id}`).value;
                editingCardId = null;
                await logic.saveToDB();
            },
            deleteCard: async (id) => {
                if(confirm('ì§„ì§œ ì‚­ì œí•¨?')) { cards = cards.filter(c => c.id !== id); await logic.saveToDB(); }
            },
            changePage: (n) => { 
                const totalPages = Math.ceil(cards.length / PAGE_SIZE) || 1;
                const nextPage = currentPage + n;
                if (nextPage >= 1 && nextPage <= totalPages) {
                    currentPage = nextPage; 
                    ui.renderList();
                    document.querySelector('.container').scrollTop = 0;
                }
            },
            prepareStudy: () => {
                const due = cards.filter(c => c.nextReview <= getTodayStr());
                if(due.length > 0) {
                    currentCard = due[0];
                    document.getElementById('study-content').style.display = 'block';
                    document.getElementById('no-study').style.display = 'none';
                    document.getElementById('card-text').innerHTML = `<div class="front">${currentCard.front}</div>`;
                    document.getElementById('rating-btns').style.display = 'none';
                } else {
                    document.getElementById('study-content').style.display = 'none';
                    document.getElementById('no-study').style.display = 'block';
                }
            },
            rateCard: async (q) => {
                let { interval, repetitions, easeFactor } = currentCard;
                if (q >= 3) {
                    if (repetitions === 0) interval = 1;
                    else if (repetitions === 1) interval = 6;
                    else interval = Math.round(interval * easeFactor);
                    repetitions++;
                } else { repetitions = 0; interval = 1; }
                if (easeFactor < 1.3) easeFactor = 1.3;

                const todayStr = getTodayStr();
                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + interval);
                
                const y = nextDate.getFullYear();
                const m = String(nextDate.getMonth() + 1).padStart(2,'0');
                const d = String(nextDate.getDate()).padStart(2,'0');
                const nextDateStr = `${y}-${m}-${d}`;

                currentCard.interval = interval; 
                currentCard.repetitions = repetitions;
                currentCard.easeFactor = easeFactor;
                currentCard.nextReview = nextDateStr;
                currentCard.lastReviewDate = todayStr;

                if (!studyLog[todayStr]) studyLog[todayStr] = 0;
                studyLog[todayStr]++;

                await logic.saveToDB();
                logic.prepareStudy();
            }
        };

        logic.loadCards();
    </script>
</body>
</html>
